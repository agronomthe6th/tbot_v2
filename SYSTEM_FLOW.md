# –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã TBOT_V2

## –û—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –¥–æ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞

---

## üìã –û–ë–©–ò–ô –û–ë–ó–û–†

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ö –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–æ–≤ (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã—Ö –º–Ω–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–µ–π–¥–µ—Ä–æ–≤), –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

---

## üîÑ –ü–û–õ–ù–´–ô –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –°–ò–ì–ù–ê–õ–ê

### –§–ê–ó–ê 1: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. TELEGRAM SCRAPER                                     ‚îÇ
‚îÇ    tbot/integrations/telegram_scraper.py                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. Telegram –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä—É–µ–º—ã–º –∫–∞–Ω–∞–ª–∞–º
2. –ü–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –∞–≤—Ç–æ—Ä, –≤—Ä–µ–º—è, —Ç–µ–∫—Å—Ç, ID –∫–∞–Ω–∞–ª–∞

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `telegram_channels`
- API credentials (api_id, api_hash)

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `raw_messages`:
  ```
  - id, timestamp, channel_id, message_id
  - author_id, author_username, author_first_name
  - text, views, forwards
  - is_processed = FALSE
  ```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ (channel_id, message_id)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–º–æ–¥–∑–∏ –∏ Unicode
- ‚ö†Ô∏è –õ–∏–º–∏—Ç—ã Telegram API (–∑–∞–ø—Ä–æ—Å—ã –≤ –º–∏–Ω—É—Ç—É)

---

### –§–ê–ó–ê 2: –ü–∞—Ä—Å–∏–Ω–≥ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. MESSAGE PARSER                                       ‚îÇ
‚îÇ    tbot/analysis/message_parser.py                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. `MessageParsingService` –∑–∞–±–∏—Ä–∞–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (`is_processed = FALSE`)
2. `MessageParser` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ë–î
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: —Ç–∏–∫–µ—Ä, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —Ü–µ–Ω—ã, –∞–≤—Ç–æ—Ä–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø–∞—Ä—Å–∏–Ω–≥–∞:**

```python
def parse_raw_message(message) -> ParseResult:
    1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–º
       - –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: "–ø–æ–∫—É–ø–∫–∞", "–ø—Ä–æ–¥–∞–∂–∞", "long", "short"
       - –ò—â–µ–º —Ç–∏–∫–µ—Ä—ã: $SBER, #GAZP, YNDX
       - –ò—â–µ–º —Ç–æ—Ä–≥–æ–≤—ã–µ —ç–º–æ–¥–∑–∏: üî•, üìà, üìâ

    2. –ò–∑–≤–ª–µ—á—å —Ç–∏–∫–µ—Ä
       - –ü–∞—Ç—Ç–µ—Ä–Ω—ã: (?:[\$#]|—Ç–∏–∫–µ—Ä:?\s*)([A-Z]{3,6})
       - –í–∞–ª–∏–¥–∞—Ü–∏—è: 3-6 –±—É–∫–≤, –Ω–µ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ (VIP, BOT –∏ —Ç.–¥.)

    3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
       - –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è LONG: "–ø–æ–∫—É–ø–∫–∞", "–∫—É–ø–∏—Ç—å", "–ª–æ–Ω–≥"
       - –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è SHORT: "–ø—Ä–æ–¥–∞–∂–∞", "–ø—Ä–æ–¥–∞—Ç—å", "—à–æ—Ä—Ç"
       - –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è EXIT: "–∑–∞–∫—Ä—ã—Ç—å", "–≤—ã—Ö–æ–¥"

    4. –ò–∑–≤–ª–µ—á—å —Ü–µ–Ω—ã
       - target_price: "—Ü–µ–ª—å", "—Ç–∞—Ä–≥–µ—Ç", "@"
       - stop_loss: "—Å—Ç–æ–ø", "sl"
       - take_profit: "–ø—Ä–æ—Ñ–∏—Ç", "tp"

    5. –ò–∑–≤–ª–µ—á—å –∞–≤—Ç–æ—Ä–∞
       - –ò—â–µ–º –∏–º—è –≤ –Ω–∞—á–∞–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
       - Fallback –Ω–∞ author_username –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

    6. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å confidence score (0.0 - 1.0)
       - +0.4 –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–∏–∫–µ—Ä
       - +0.3 –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
       - +0.2 –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—é
       - +0.05 –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π
       - +0.05 –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞

    7. –í–µ—Ä–Ω—É—Ç—å ParseResult
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `parsed_signals`:
  ```
  - id (UUID)
  - ticker, direction, signal_type
  - target_price, stop_loss, take_profit
  - author, confidence_score
  - timestamp, original_text
  ```
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `raw_messages.is_processed = TRUE`

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∞ –î–û –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞—Ç –∏ —Ü–µ–Ω
- ‚ö†Ô∏è –ù–∏–∑–∫–∏–π confidence score (<0.5) = –≤–æ–∑–º–æ–∂–Ω–∞—è –æ—à–∏–±–∫–∞

---

### –§–ê–ó–ê 3: –î–µ—Ç–µ–∫—Ü–∏—è –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. CONSENSUS DETECTOR                                   ‚îÇ
‚îÇ    tbot/analysis/consensus_detector.py                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ (event-driven)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –¥—Ä—É–≥–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –æ–∫–Ω–µ –≤—Ä–µ–º–µ–Ω–∏
3. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Å–µ–Ω—Å—É—Å ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ

**–ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–µ–∫—Ü–∏–∏:**

```python
def check_new_signal_sync(signal_id) -> Optional[Dict]:
    1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –∏–∑ –ë–î
       ORDER BY priority DESC

    2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞:
        # –§–∏–ª—å—Ç—Ä—ã
        if rule.ticker_filter:
            if signal.ticker not in rule.tickers:
                continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–æ

        if rule.direction_filter:
            if signal.direction != rule.direction_filter:
                continue

        # –ü–æ–∏—Å–∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –≤ –æ–∫–Ω–µ
        window_start = signal.timestamp - window_minutes / 2
        window_end = signal.timestamp + window_minutes / 2

        window_signals = SELECT * FROM parsed_signals WHERE:
            - ticker = signal.ticker
            - signal_type = 'entry'
            - timestamp BETWEEN window_start AND window_end
            - direction IS NOT NULL

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç—Ä–µ–π–¥–µ—Ä–æ–≤
        unique_authors = COUNT(DISTINCT author FROM window_signals)
        if unique_authors < rule.min_traders:
            continue

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if rule.strict_consensus:
            if EXISTS (different directions):
                continue  # –û—Ç–∫–ª–æ–Ω—è–µ–º –ø—Ä–∏ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è—Ö

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã)
        if rule.indicator_conditions:
            candles = GET last 100 candles for ticker
            if len(candles) < 30:
                return FALSE  # ‚ö†Ô∏è –ë–ê–ì #5 –ò–°–ü–†–ê–í–õ–ï–ù

            indicators = TechnicalIndicators.calculate_all(candles)

            for indicator in rule.indicator_conditions:
                if indicator == 'rsi':
                    if NOT (min_rsi <= current_rsi <= max_rsi):
                        continue

                if indicator == 'macd':
                    if signal != expected_signal:
                        continue

                # –¢–æ –∂–µ –¥–ª—è bollinger, obv...

        # –ö–û–ù–°–ï–ù–°–£–° –ù–ê–ô–î–ï–ù!
        3. –°–æ–∑–¥–∞—Ç—å ConsensusEvent:
            - ticker, direction, traders_count
            - window_minutes, first_signal_at, last_signal_at
            - avg_entry_price (—Å—Ä–µ–¥–Ω–µ–µ –∏–∑ –≤—Å–µ—Ö —Å–∏–≥–Ω–∞–ª–æ–≤)
            - price_spread_pct (—Ä–∞–∑–±—Ä–æ—Å —Ü–µ–Ω)
            - consensus_strength (0-100)

        4. –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑–∏ ConsensusSignal:
            FOR each signal in consensus:
                INSERT INTO consensus_signals (consensus_id, signal_id)

        5. –í–µ—Ä–Ω—É—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–µ

    return None  # –ö–æ–Ω—Å–µ–Ω—Å—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
```

**–†–∞—Å—á–µ—Ç —Å–∏–ª—ã –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ (0-100):**

```python
def _calculate_strength(consensus_data) -> int:
    strength = 50  # –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

    # –§–∞–∫—Ç–æ—Ä 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–π–¥–µ—Ä–æ–≤
    if traders_count >= 5: strength += 20
    elif traders_count >= 4: strength += 10

    # –§–∞–∫—Ç–æ—Ä 2: –†–∞–∑–±—Ä–æ—Å —Ü–µ–Ω (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ)
    if price_spread < 1%: strength += 15
    elif price_spread < 2%: strength += 5
    elif price_spread > 5%: strength -= 10

    # –§–∞–∫—Ç–æ—Ä 3: –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫—É—á–Ω–æ—Å—Ç—å
    time_span = last_signal_time - first_signal_time
    if time_span < 10 min: strength += 15
    elif time_span < 20 min: strength += 5

    return min(100, max(0, strength))
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø–∏—Å—å –≤ `consensus_events`:
  ```
  - id (UUID), rule_id, ticker, direction
  - traders_count, window_minutes
  - first_signal_at, last_signal_at
  - avg_entry_price, price_spread_pct
  - consensus_strength, status='active'
  ```
- –ó–∞–ø–∏—Å–∏ –≤ `consensus_signals` (—Å–≤—è–∑—å N:M)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ Event-driven: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–∏–≥–Ω–∞–ª–µ
- ‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–ø–µ—Ä–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
- ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –º–∏–Ω–∏–º—É–º 30 —Å–≤–µ—á–µ–π
- ‚ö†Ô∏è –§–ò–öS–∏—Ä–æ–≤–∞–Ω –ë–ê–ì: False positive –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö

---

### –§–ê–ó–ê 4: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. TINKOFF INTEGRATION                                  ‚îÇ
‚îÇ    tbot/integrations/tinkoff_integration.py             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Tinkoff API
2. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤–µ—á–∏ –≤ –ë–î
3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤

**API –º–µ—Ç–æ–¥—ã:**

```python
# 1. –ü–æ–∏—Å–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
instrument = find_instrument_by_ticker("SBER")
‚Üí {figi, ticker, name, type, currency, lot}

# 2. –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ (—Å retry + rate limiting)
@async_retry(max_attempts=3, timeout=30)
async def get_current_price(ticker):
    await rate_limiter.acquire()  # ‚ö†Ô∏è Max 100 req/min
    response = await client.market_data.get_last_prices([figi])
    return {price, timestamp, source}

# 3. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏
@async_retry(max_attempts=3, timeout=60)
async def get_candles(figi, interval, from_time, to_time):
    await rate_limiter.acquire()
    candles = client.get_all_candles(...)

    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
    validated = _validate_and_deduplicate_candles(candles)
    return validated
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤–µ—á–µ–π:**

```python
def _validate_and_deduplicate_candles(candles):
    valid_candles = []
    seen_times = set()

    for candle in candles:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if missing required fields:
            skip

        # 2. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ë–ê–ì #12 –ò–°–ü–†–ê–í–õ–ï–ù)
        if candle.time in seen_times:
            skip
        seen_times.add(candle.time)

        # 3. –õ–æ–≥–∏—á–Ω–æ—Å—Ç—å OHLC
        if NOT (low <= open <= high AND low <= close <= high):
            skip

        # 4. –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
        if any(price <= 0):
            skip

        valid_candles.append(candle)

    return valid_candles
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –ó–∞–ø–∏—Å—å –≤ `candles`:
  ```
  - instrument_id (figi), interval, time
  - open, high, low, close, volume
  ```
- Unique constraint: (instrument_id, interval, time)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Retry logic —Å exponential backoff
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Rate limiting (100 req/min)
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Timeout –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (30-60s)
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–≤–µ—á–µ–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- ‚ö†Ô∏è Sandbox/Production mode —á–µ—Ä–µ–∑ env var

---

### –§–ê–ó–ê 5: –ë—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. CONSENSUS BACKTESTER                                 ‚îÇ
‚îÇ    tbot/analysis/consensus_backtester.py                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–∏–º—É–ª—è—Ü–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø–æ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞–º –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. –†–∞—Å—á–µ—Ç P&L —Å —É—á–µ—Ç–æ–º —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞
3. –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º –±—ç–∫—Ç–µ—Å—Ç–∞:**

```python
def run_backtest(rule_id, start_date, end_date, params):
    # –í–ê–õ–ò–î–ê–¶–ò–Ø (–ë–ê–ì #11 –ò–°–ü–†–ê–í–õ–ï–ù)
    if take_profit_pct <= 0 OR > 100: raise ValueError
    if stop_loss_pct <= 0 OR > 100: raise ValueError
    if initial_capital <= 0: raise ValueError
    # ...

    capital = initial_capital
    results = []

    # 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã –≤ –ø–µ—Ä–∏–æ–¥–µ
    signals = SELECT * FROM parsed_signals WHERE:
        - timestamp BETWEEN start_date AND end_date
        - signal_type = 'entry'
        - ticker IN tickers (if specified)

    # 2. –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–µ–Ω—Å—É—Å—ã (–∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª–æ)
    consensus_events = []
    processed_signals = set()

    for signal in signals:
        if signal.id in processed_signals:
            continue

        consensus_data = detector._find_consensus_window(
            signal, rule.window_minutes, rule.min_traders, rule
        )

        if consensus_data:
            # –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞
            for cs in consensus_data.signals:
                processed_signals.add(cs.id)

            consensus_events.append({
                ticker, direction, timestamp,
                traders_count, avg_price
            })

    # 3. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Å–¥–µ–ª–∫—É
    for event in consensus_events:
        result = _simulate_trade(event, capital, params)
        if result:
            capital += result.profit_abs  # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ø–∏—Ç–∞–ª
            result.capital_after = capital
            results.append(result)

    # 4. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = _calculate_statistics(results, initial_capital)

    # 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
    INSERT INTO consensus_backtests (
        rule_id, start_date, end_date,
        total_consensus_found, profitable_count, loss_count,
        win_rate, avg_profit_pct, total_return_pct,
        results_by_ticker, consensus_details
    )

    return {backtest_id, stats, results, final_capital}
```

**–°–∏–º—É–ª—è—Ü–∏—è –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–∏:**

```python
def _simulate_trade(event, capital, params):
    # 1. –ü–æ–ª—É—á–∏—Ç—å FIGI
    figi = SELECT figi FROM instruments WHERE ticker = event.ticker

    # 2. –ù–∞–π—Ç–∏ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ (–ø–µ—Ä–≤–∞—è —Å–≤–µ—á–∞ –ø–æ—Å–ª–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞)
    entry_candle = SELECT * FROM candles WHERE:
        - instrument_id = figi
        - time >= event.timestamp
        - interval = 'hour'
    ORDER BY time LIMIT 1

    if NOT entry_candle:
        return None  # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö

    entry_price = entry_candle.close

    # 3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
    position_value = capital * (position_size_pct / 100)
    shares = int(position_value / entry_price)

    if shares <= 0:  # –ë–ê–ì #6 –ò–°–ü–†–ê–í–õ–ï–ù
        return None

    # 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ä–æ–≤–Ω–∏ –≤—ã—Ö–æ–¥–∞
    if direction == 'long':
        take_profit_price = entry_price * (1 + take_profit_pct/100)
        stop_loss_price = entry_price * (1 - stop_loss_pct/100)
    else:  # short
        take_profit_price = entry_price * (1 - take_profit_pct/100)
        stop_loss_price = entry_price * (1 + stop_loss_pct/100)

    # 5. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
    exit_time = entry_time + holding_hours
    candles = SELECT * FROM candles WHERE:
        - instrument_id = figi
        - time > entry_candle.time
        - time <= exit_time
        - interval = 'hour'
    ORDER BY time

    # –ë–ê–ì #2 –ò–°–ü–†–ê–í–õ–ï–ù: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö
    if NOT candles:
        last_candle = SELECT * FROM candles WHERE:
            - instrument_id = figi
            - time > entry_candle.time
        ORDER BY time DESC LIMIT 1

        if last_candle:
            exit_price = last_candle.close
            exit_reason = 'timeout'
        else:
            return None  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–¥–µ–ª–∫—É –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö

    else:
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–≤–µ—á–∞–º, –∏—â–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã
        for candle in candles:
            if direction == 'long':
                if candle.high >= take_profit_price:
                    exit_price = take_profit_price
                    exit_reason = 'take_profit'
                    break
                if candle.low <= stop_loss_price:
                    exit_price = stop_loss_price
                    exit_reason = 'stop_loss'
                    break
            # –¢–æ –∂–µ –¥–ª—è short...

            exit_price = candle.close  # –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª TP/SL
            exit_reason = 'timeout'

    # 6. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å P&L
    if direction == 'long':
        pnl_pct = ((exit_price - entry_price) / entry_price) * 100
    else:
        pnl_pct = ((entry_price - exit_price) / entry_price) * 100

    profit_abs = shares * entry_price * (pnl_pct / 100)

    return {
        ticker, direction,
        entry_time, exit_time,
        entry_price, exit_price,
        shares, position_value,
        pnl_pct, profit_abs,
        exit_reason, traders_count
    }
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- –û–±—ä–µ–∫—Ç –≤ –ø–∞–º—è—Ç–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- –ó–∞–ø–∏—Å—å –≤ `consensus_backtests` —Å –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- –î–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏ –≤ JSON `consensus_details`

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–ø—É—Å–∫ —Å–¥–µ–ª–æ–∫ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ P&L=0
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ shares <= 0
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–∏
- ‚ö†Ô∏è –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç: Stop Loss, Take Profit, Position Sizing

---

### –§–ê–ó–ê 6: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π (Live Trading)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. SIGNAL MATCHER                                       ‚îÇ
‚îÇ    tbot/analysis/signal_matcher.py                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
2. –ü–æ–∏—Å–∫ —Ü–µ–Ω –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ API –∏–ª–∏ –ë–î
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≤—ã—Ö–æ–¥–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```python
async def process_untracked_signals(limit=50):
    # 1. –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
    untracked = SELECT * FROM parsed_signals WHERE:
        - id NOT IN (SELECT signal_id FROM signal_results)
        - direction IN ('long', 'short')
        - timestamp >= NOW() - 7 days
    ORDER BY timestamp LIMIT {limit}

    for signal in untracked:
        # 2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—Å—Ç—å –≤ –ë–î
        figi = await ensure_instrument_in_database(signal.ticker)
        if NOT figi:
            # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä–µ–∑ API
            api_instrument = await tinkoff.find_instrument_by_ticker(ticker)
            if api_instrument:
                INSERT INTO instruments (...)
                figi = api_instrument.figi
            else:
                continue  # –ù–µ –Ω–∞–π–¥–µ–Ω

        # 3. –ù–∞–π—Ç–∏ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞
        entry_match = await _find_entry_price(signal, figi)

        if entry_match:
            # 4. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            INSERT INTO signal_results (
                signal_id,
                planned_entry_price = signal.target_price,
                actual_entry_price = entry_match.actual_price,
                entry_time = entry_match.price_time,
                status = 'active'
            )

async def _find_entry_price(signal, figi):
    signal_time = signal.timestamp
    search_end = signal_time + 1 hour

    # –ü–û–ü–´–¢–ö–ê 1: –ü–æ–∏—Å–∫ –≤ –ë–î
    candles = SELECT * FROM candles WHERE:
        - instrument_id = figi
        - interval = '5min'
        - time >= signal_time
        - time <= search_end
    ORDER BY time LIMIT 12

    if candles:
        entry_price = candles[0].open
        entry_time = candles[0].time
    else:
        # –ü–û–ü–´–¢–ö–ê 2: API (—Å retry + rate limiting + timeout)
        if NOT tinkoff:
            return None

        price_data = await tinkoff.get_current_price(ticker)
        if NOT price_data:
            return None

        entry_price = price_data.price
        entry_time = NOW()

    # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ
    slippage_pct = ((entry_price - target_price) / target_price) * 100

    return PriceMatch(
        signal_id, signal_time, target_price,
        entry_price, entry_time, slippage_pct, delay_minutes
    )
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π:**

```python
async def update_active_positions():
    # –ë–ê–ì #3 –ò–°–ü–†–ê–í–õ–ï–ù: SELECT FOR UPDATE –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
    WITH db.session() as session:
        results = SELECT * FROM signal_results WHERE:
            - status = 'active'
        FOR UPDATE SKIP LOCKED  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏

        for position in results:
            signal = GET signal_by_id(position.signal_id)
            figi = await ensure_instrument_in_database(signal.ticker)

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏—è –≤—ã—Ö–æ–¥–∞
            current_price = await _get_current_price(figi, signal.ticker)

            # Stop Loss
            if signal.stop_loss:
                if (direction=='long' AND current_price <= stop_loss) OR
                   (direction=='short' AND current_price >= stop_loss):
                    UPDATE signal_results SET:
                        exit_price = current_price
                        exit_time = NOW()
                        exit_reason = 'stop_loss'
                        status = 'closed'

            # Take Profit
            if signal.take_profit:
                if (direction=='long' AND current_price >= take_profit) OR
                   (direction=='short' AND current_price <= take_profit):
                    UPDATE signal_results SET:
                        exit_price = current_price
                        exit_time = NOW()
                        exit_reason = 'take_profit'
                        status = 'closed'

            # Timeout (24 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            if position.tracking_started_at + 24 hours < NOW():
                UPDATE signal_results SET:
                    exit_price = current_price
                    exit_time = NOW()
                    exit_reason = 'timeout'
                    status = 'closed'
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏:**
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: SELECT FOR UPDATE SKIP LOCKED (race conditions)
- ‚úÖ –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø–æ–∏—Å–∫ —Ü–µ–Ω: –ë–î ‚Üí API
- ‚úÖ Retry + Rate Limiting + Timeout –¥–ª—è API
- ‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –ø–æ–∑–∏—Ü–∏–π: 24 —á–∞—Å–∞

---

### –§–ê–ó–ê 7: API & –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. FASTAPI APPLICATION                                  ‚îÇ
‚îÇ    tbot/api/app.py                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

```
# –ö–æ–Ω—Å–µ–Ω—Å—É—Å—ã
GET    /api/consensus/rules
POST   /api/consensus/rules
PUT    /api/consensus/rules/{id}
DELETE /api/consensus/rules/{id}
GET    /api/consensus/detections
POST   /api/consensus/detect

# –ë—ç–∫—Ç–µ—Å—Ç—ã
POST   /api/consensus/backtest
GET    /api/consensus/backtest/{id}

# –°–∏–≥–Ω–∞–ª—ã
GET    /api/signals?ticker=SBER&direction=long&status=active
GET    /api/signals/stats

# Telegram
POST   /api/telegram/channels
GET    /api/telegram/channels
POST   /api/telegram/start_scraping
POST   /api/telegram/stop_scraping

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
GET    /api/health
GET    /api/stats
```

---

## üóÑÔ∏è –ë–ê–ó–ê –î–ê–ù–ù–´–•

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

```sql
raw_messages (—Å—ã—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  ‚Üì
parsed_signals (—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã)
  ‚Üì
consensus_events (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—ã)
  ‚Üì
consensus_signals (—Å–≤—è–∑—å N:M)

signal_results (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π)

candles (—Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
instruments (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
consensus_rules (–ø—Ä–∞–≤–∏–ª–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏)
consensus_backtests (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤)
```

---

## ‚öôÔ∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´

### Thread Safety:
- ‚úÖ Singleton —Å double-check locking
- ‚úÖ SELECT FOR UPDATE –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
- ‚úÖ Deadlock retry —Å exponential backoff

### API Resilience:
- ‚úÖ Retry logic (3 –ø–æ–ø—ã—Ç–∫–∏, exp backoff)
- ‚úÖ Rate limiting (100 req/min)
- ‚úÖ Timeouts (30-60s)
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### Data Validation:
- ‚úÖ –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫—Ç–µ—Å—Ç–∞
- ‚úÖ OHLC —Å–≤–µ—á–µ–π
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

## üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ü–†–û–î–ê–ö–®–ï–ù–£

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏:
1. ‚úÖ Async/Sync mismatch
2. ‚úÖ Silent failure –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ Race conditions –≤ SignalMatcher
4. ‚úÖ Retry logic –¥–ª—è API
5. ‚úÖ False positive –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö shares
7. ‚úÖ Rate limiting
8. ‚úÖ Timeout –æ–±—Ä–∞–±–æ—Ç–∫–∞
9. ‚úÖ Deadlock retry
10. ‚úÖ Thread-safe singleton
11. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
12. ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–≤–µ—á–µ–π

### –ß—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ:
- ‚ö†Ô∏è –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Sentry)
- ‚ö†Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ (Prometheus)
- ‚ö†Ô∏è –ê–ª–µ—Ä—Ç—ã (PagerDuty/Telegram)
- ‚ö†Ô∏è –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (coverage > 70%)
- ‚ö†Ô∏è Graceful shutdown
- ‚ö†Ô∏è Circuit breaker pattern
- ‚ö†Ô∏è Secrets management

---

## üìä –ü–†–ò–ú–ï–† –ü–û–õ–ù–û–ì–û –ü–û–¢–û–ö–ê

```
1. Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ: "üî• SBER –ø–æ–∫—É–ø–∫–∞ @ 280‚ÇΩ, —Ü–µ–ª—å 290‚ÇΩ, —Å—Ç–æ–ø 275‚ÇΩ - –ò–≤–∞–Ω"
   ‚Üì
2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: raw_messages (id=123, text="...", is_processed=FALSE)
   ‚Üì
3. –ü–∞—Ä—Å–∏–Ω–≥: parsed_signals (
      ticker="SBER", direction="long", target_price=280,
      take_profit=290, stop_loss=275, author="–ò–≤–∞–Ω"
   )
   ‚Üì
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞: –ù–∞–π–¥–µ–Ω—ã –µ—â–µ 2 —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç "–ü–µ—Ç—Ä" –∏ "–ú–∞—Ä–∏—è" –Ω–∞ SBER long
   ‚Üì
5. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞: consensus_events (
      ticker="SBER", direction="long", traders_count=3,
      avg_entry_price=279, consensus_strength=75
   )
   ‚Üì
6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤: RSI=35 (–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω), MACD=bullish ‚Üí –û–ö
   ‚Üì
7. –ë—ç–∫—Ç–µ—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): –¢–µ—Å—Ç –Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ ‚Üí Win rate=68%, Avg profit=3.2%
   ‚Üì
8. Live tracking: –û–∂–∏–¥–∞–Ω–∏–µ —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TP/SL
   ‚Üì
9. –í—ã—Ö–æ–¥: Take profit –¥–æ—Å—Ç–∏–≥–Ω—É—Ç @ 290‚ÇΩ, P&L = +3.6%
   ‚Üì
10. –†–µ–∑—É–ª—å—Ç–∞—Ç: signal_results (status='closed', profit_loss_pct=3.6)
```

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** 2024
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** TBOT_V2
**–°—Ç–∞—Ç—É—Å:** Production-ready –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤
