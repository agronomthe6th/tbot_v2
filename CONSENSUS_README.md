# Система Консенсусов (Consensus System)

## Оглавление
- [Введение](#введение)
- [Архитектура](#архитектура)
- [Создание Правил Консенсуса](#создание-правил-консенсуса)
- [Технические Индикаторы](#технические-индикаторы)
- [Система Бэктестинга](#система-бэктестинга)
- [API Endpoints](#api-endpoints)
- [Frontend](#frontend)
- [Примеры Использования](#примеры-использования)

---

## Введение

Система консенсусов - это инструмент для автоматического обнаружения торговых возможностей на основе согласованных сигналов от нескольких трейдеров. Система анализирует позиции и действия трейдеров, применяет фильтры и технические индикаторы, и генерирует сигналы на покупку/продажу.

### Основные возможности:
- ✅ Гибкая настройка правил консенсуса
- ✅ Поддержка технических индикаторов (RSI, MACD, Bollinger Bands, OBV)
- ✅ Полноценная система бэктестинга с управлением капиталом
- ✅ Визуализация результатов на фронтенде
- ✅ Автоматическое обнаружение консенсусов в реальном времени

---

## Архитектура

### Компоненты системы:

```
/tbot/
├── analysis/
│   ├── consensus_detector.py      # Основной детектор консенсусов
│   ├── consensus_backtester.py    # Система бэктестинга
│   └── technical_indicators.py    # Технические индикаторы
├── core/
│   └── database/
│       ├── models.py              # Модели данных (ConsensusRule, ConsensusBacktest)
│       └── migrations.py          # Миграции БД
└── api/
    └── app.py                     # API endpoints

/frontend/
└── src/
    ├── views/
    │   └── ConsensusPage.vue      # Главная страница консенсусов
    └── components/
        └── ConsensusBacktest.vue  # Компонент бэктестинга
```

### Модели данных:

#### ConsensusRule
Правило для обнаружения консенсуса:
- `name` - название правила
- `min_traders` - минимальное количество трейдеров
- `min_total_amount` - минимальная общая сумма позиций (руб.)
- `max_traders` - максимальное количество трейдеров
- `max_total_amount` - максимальная общая сумма (руб.)
- `allowed_tickers` - список разрешенных тикеров
- `indicator_conditions` - условия по техническим индикаторам (JSONB)
- `is_active` - активно ли правило

#### ConsensusBacktest
Результат бэктеста:
- `rule_id` - ID правила
- `start_date`, `end_date` - период тестирования
- `total_consensus_found` - найдено консенсусов
- `win_rate` - процент прибыльных сделок
- `total_return_pct` - общая доходность в %
- `total_profit_abs` - общая прибыль в рублях
- `avg_profit_pct`, `avg_loss_pct` - средняя прибыль/убыток
- `max_profit_pct`, `max_loss_pct` - максимальная прибыль/убыток
- `detailed_results` - детальные результаты сделок (JSONB)

---

## Создание Правил Консенсуса

### Через Frontend

1. Откройте страницу "Консенсусы" в веб-интерфейсе
2. Нажмите кнопку "Создать правило"
3. Заполните основные параметры:
   - **Название** - описательное имя правила
   - **Мин. трейдеров** - минимальное количество трейдеров для консенсуса
   - **Макс. трейдеров** - максимальное количество (опционально)
   - **Мин. сумма** - минимальная общая сумма позиций в рублях
   - **Макс. сумма** - максимальная сумма (опционально)
   - **Тикеры** - список разрешенных тикеров (через запятую, или пусто для всех)

4. Настройте технические индикаторы (опционально):
   - **RSI** - задайте диапазон (например, 30-70)
   - **MACD** - выберите сигнал (bullish_crossover/bearish_crossover)
   - **Bollinger Bands** - выберите сигнал (below_lower/above_upper)
   - **OBV** - выберите сигнал (increasing/decreasing)

5. Сохраните правило

### Через API

```python
import requests

payload = {
    "name": "Сильный бычий консенсус",
    "min_traders": 3,
    "min_total_amount": 500000,
    "max_traders": 10,
    "allowed_tickers": ["SBER", "GAZP", "LKOH"],
    "indicator_conditions": {
        "rsi": {
            "enabled": True,
            "min": 30,
            "max": 70
        },
        "macd": {
            "enabled": True,
            "signal": "bullish_crossover"
        }
    },
    "is_active": True
}

response = requests.post('http://localhost:8000/api/consensus/rules', json=payload)
rule = response.json()
```

---

## Технические Индикаторы

Система поддерживает следующие технические индикаторы:

### RSI (Relative Strength Index)
Индекс относительной силы - показывает перекупленность/перепроданность актива.

**Параметры:**
- `enabled` - включить индикатор
- `min` - минимальное значение RSI (обычно 30 для перепроданности)
- `max` - максимальное значение RSI (обычно 70 для перекупленности)

**Пример:**
```json
{
  "rsi": {
    "enabled": true,
    "min": 30,
    "max": 70
  }
}
```

### MACD (Moving Average Convergence Divergence)
Схождение/расхождение скользящих средних - показывает силу и направление тренда.

**Параметры:**
- `enabled` - включить индикатор
- `signal` - тип сигнала:
  - `bullish_crossover` - бычье пересечение (MACD пересекает сигнальную линию снизу вверх)
  - `bearish_crossover` - медвежье пересечение (MACD пересекает сигнальную линию сверху вниз)

**Пример:**
```json
{
  "macd": {
    "enabled": true,
    "signal": "bullish_crossover"
  }
}
```

### Bollinger Bands
Полосы Боллинджера - показывают волатильность и потенциальные точки разворота.

**Параметры:**
- `enabled` - включить индикатор
- `signal` - тип сигнала:
  - `below_lower` - цена ниже нижней полосы (потенциальная покупка)
  - `above_upper` - цена выше верхней полосы (потенциальная продажа)

**Пример:**
```json
{
  "bollinger": {
    "enabled": true,
    "signal": "below_lower"
  }
}
```

### OBV (On-Balance Volume)
Балансовый объем - показывает соотношение объемов при росте и падении цены.

**Параметры:**
- `enabled` - включить индикатор
- `signal` - тип сигнала:
  - `increasing` - OBV растет (подтверждение роста)
  - `decreasing` - OBV падает (подтверждение падения)

**Пример:**
```json
{
  "obv": {
    "enabled": true,
    "signal": "increasing"
  }
}
```

---

## Система Бэктестинга

Система бэктестинга позволяет проверить эффективность правил консенсуса на исторических данных с учетом реального управления капиталом.

### Основные возможности:

- **Управление капиталом** - задайте начальный капитал и размер позиции в %
- **Take Profit / Stop Loss** - настройте уровни фиксации прибыли и ограничения убытков
- **Время удержания** - максимальное время удержания позиции
- **Детальная статистика** - win rate, доходность, средняя прибыль/убыток
- **Детали сделок** - полный лог всех сделок с причинами выхода

### Параметры бэктеста:

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `initial_capital` | Начальный капитал (₽) | 100,000 |
| `position_size_pct` | Размер позиции (% от капитала) | 10.0 |
| `take_profit_pct` | Take Profit (%) | 5.0 |
| `stop_loss_pct` | Stop Loss (%) | 3.0 |
| `holding_hours` | Макс. время удержания (часы) | 24 |

### Как работает бэктест:

1. **Обнаружение консенсусов** - система сканирует исторические данные и находит все моменты, когда правило сработало

2. **Расчет размера позиции**:
   ```python
   position_value = capital * position_size_pct / 100
   shares = int(position_value / entry_price)
   ```

3. **Симуляция сделки**:
   - Вход по цене закрытия свечи, где обнаружен консенсус
   - Мониторинг последующих свечей
   - Выход при срабатывании TP, SL или таймаута

4. **Расчет результата**:
   ```python
   profit_abs = shares * entry_price * (pnl_pct / 100)
   total_return_pct = (total_profit_abs / initial_capital) * 100
   ```

### Пример запуска через API:

```python
import requests
from datetime import datetime, timedelta

payload = {
    "rule_id": 1,
    "start_date": (datetime.now() - timedelta(days=90)).isoformat(),
    "end_date": datetime.now().isoformat(),
    "tickers": ["SBER", "GAZP"],  # опционально
    "initial_capital": 100000.0,
    "position_size_pct": 10.0,
    "take_profit_pct": 5.0,
    "stop_loss_pct": 3.0,
    "holding_hours": 24
}

response = requests.post('http://localhost:8000/api/consensus/backtest', json=payload)
result = response.json()

print(f"Win Rate: {result['stats']['win_rate']}%")
print(f"Total Return: {result['stats']['total_return_pct']}%")
print(f"Profit: {result['stats']['total_profit_abs']} ₽")
```

### Интерпретация результатов:

- **Win Rate > 60%** - хорошая стратегия
- **Win Rate 50-60%** - приемлемая стратегия (проверьте avg_profit vs avg_loss)
- **Win Rate < 50%** - стратегия требует доработки

**Важно:** Высокий win rate не всегда означает прибыльность. Проверяйте соотношение средней прибыли к среднему убытку (profit factor).

---

## API Endpoints

### Управление правилами

#### Получить список правил
```http
GET /api/consensus/rules
```

**Ответ:**
```json
{
  "rules": [
    {
      "id": 1,
      "name": "Сильный бычий консенсус",
      "min_traders": 3,
      "min_total_amount": 500000,
      "is_active": true,
      "indicator_conditions": {...}
    }
  ]
}
```

#### Создать правило
```http
POST /api/consensus/rules
Content-Type: application/json

{
  "name": "Название правила",
  "min_traders": 3,
  "min_total_amount": 500000,
  "indicator_conditions": {...}
}
```

#### Обновить правило
```http
PUT /api/consensus/rules/{rule_id}
Content-Type: application/json

{
  "name": "Новое название",
  "is_active": false
}
```

#### Удалить правило
```http
DELETE /api/consensus/rules/{rule_id}
```

### Обнаружение консенсусов

#### Запустить обнаружение вручную
```http
POST /api/consensus/detect
```

#### Получить обнаруженные консенсусы
```http
GET /api/consensus/detections?limit=50
```

### Бэктестинг

#### Запустить бэктест
```http
POST /api/consensus/backtest
Content-Type: application/json

{
  "rule_id": 1,
  "start_date": "2024-01-01T00:00:00Z",
  "end_date": "2024-03-01T00:00:00Z",
  "initial_capital": 100000.0,
  "position_size_pct": 10.0,
  "take_profit_pct": 5.0,
  "stop_loss_pct": 3.0,
  "holding_hours": 24
}
```

**Ответ:**
```json
{
  "backtest_id": "uuid",
  "stats": {
    "total_consensus_found": 45,
    "win_rate": 62.5,
    "total_return_pct": 15.3,
    "total_profit_abs": 15300,
    "profitable_count": 28,
    "loss_count": 17,
    "avg_profit_pct": 3.2,
    "avg_loss_pct": -2.1,
    "max_profit_pct": 8.5,
    "max_loss_pct": -3.0,
    "by_ticker": {
      "SBER": {
        "count": 20,
        "profitable": 13,
        "total_pnl": 8.5,
        "total_profit_abs": 8500
      }
    }
  },
  "results": [
    {
      "ticker": "SBER",
      "direction": "long",
      "entry_price": 250.0,
      "exit_price": 262.5,
      "pnl_pct": 5.0,
      "profit_abs": 500,
      "exit_reason": "take_profit",
      "shares": 40,
      "traders_count": 4
    }
  ]
}
```

#### Получить результаты бэктеста
```http
GET /api/consensus/backtest/{backtest_id}
```

#### Получить историю бэктестов для правила
```http
GET /api/consensus/backtest/rule/{rule_id}?limit=10
```

---

## Frontend

### Страница консенсусов (ConsensusPage.vue)

Главная страница разделена на три вкладки:

1. **Правила** - управление правилами консенсуса
   - Создание/редактирование/удаление правил
   - Настройка технических индикаторов
   - Активация/деактивация правил

2. **Обнаружения** - список обнаруженных консенсусов
   - История всех срабатываний правил
   - Фильтрация по тикерам и датам
   - Детали каждого консенсуса

3. **Бэктестинг** - тестирование правил на истории
   - Форма запуска бэктеста
   - Визуализация результатов
   - История прошлых бэктестов

### Компонент бэктестинга (ConsensusBacktest.vue)

Интерактивный интерфейс для:
- Выбора правила и периода тестирования
- Настройки параметров торговли и капитала
- Просмотра детальной статистики
- Анализа каждой сделки

---

## Примеры Использования

### Пример 1: Простое правило на основе количества трейдеров

Создайте правило, которое срабатывает, когда минимум 5 трейдеров открыли позиции на сумму от 1 млн рублей:

```json
{
  "name": "5+ трейдеров, 1M+ рублей",
  "min_traders": 5,
  "min_total_amount": 1000000,
  "is_active": true
}
```

### Пример 2: Правило с RSI фильтром

Консенсус только когда RSI показывает перепроданность:

```json
{
  "name": "Консенсус при перепроданности",
  "min_traders": 3,
  "min_total_amount": 500000,
  "indicator_conditions": {
    "rsi": {
      "enabled": true,
      "min": 0,
      "max": 30
    }
  },
  "is_active": true
}
```

### Пример 3: Комбинированное правило с MACD и Bollinger Bands

Строгое правило с несколькими техническими фильтрами:

```json
{
  "name": "Сильный бычий сигнал",
  "min_traders": 4,
  "min_total_amount": 750000,
  "allowed_tickers": ["SBER", "GAZP", "LKOH", "ROSN"],
  "indicator_conditions": {
    "macd": {
      "enabled": true,
      "signal": "bullish_crossover"
    },
    "bollinger": {
      "enabled": true,
      "signal": "below_lower"
    },
    "obv": {
      "enabled": true,
      "signal": "increasing"
    }
  },
  "is_active": true
}
```

### Пример 4: Бэктест с консервативными параметрами

Запуск бэктеста с небольшими позициями и строгими ограничениями:

```python
backtest_params = {
    "rule_id": 3,
    "start_date": "2024-01-01T00:00:00Z",
    "end_date": "2024-03-01T00:00:00Z",
    "initial_capital": 500000.0,  # 500k рублей
    "position_size_pct": 5.0,      # только 5% капитала на позицию
    "take_profit_pct": 3.0,        # консервативный TP
    "stop_loss_pct": 2.0,          # жесткий SL
    "holding_hours": 12            # короткое удержание
}
```

---

## Миграция Базы Данных

Для применения изменений в схеме базы данных (добавление полей для индикаторов и таблицы бэктестов):

```bash
# Запустите скрипт миграции
python run_consensus_migration.py
```

Скрипт автоматически:
1. Проверит наличие колонки `indicator_conditions` в таблице `consensus_rules`
2. Создаст таблицу `consensus_backtests` если её нет
3. Добавит необходимые индексы

---

## Troubleshooting

### Бэктест показывает нулевые результаты

**Проблема:** Все статистики показывают 0.0%

**Решение:**
- Убедитесь, что в выбранном периоде есть данные свечей
- Проверьте, что правило действительно срабатывает (посмотрите `total_consensus_found`)
- Увеличьте период тестирования
- Проверьте параметры TP/SL - возможно они слишком строгие

### Правило не срабатывает

**Проблема:** Консенсусы не обнаруживаются

**Решение:**
- Проверьте, что правило активно (`is_active = true`)
- Уменьшите `min_traders` или `min_total_amount`
- Проверьте, что технические индикаторы не слишком строгие
- Убедитесь, что в системе есть данные о позициях трейдеров

### Технические индикаторы не работают

**Проблема:** Индикаторы не влияют на результаты

**Решение:**
- Проверьте формат `indicator_conditions` в JSON
- Убедитесь, что `enabled = true` для нужных индикаторов
- Проверьте наличие свечных данных (минимум 50 свечей для расчета)
- Посмотрите логи бэкенда на предмет ошибок

---

## Дополнительная Информация

### Технические детали реализации

- **Детектор консенсусов** (`consensus_detector.py`): работает через анализ сигналов трейдеров
- **Технические индикаторы** (`technical_indicators.py`): используют pandas и numpy для расчетов
- **Бэктестер** (`consensus_backtester.py`): симулирует реальную торговлю с учетом комиссий
- **База данных**: PostgreSQL с JSONB для гибкого хранения условий

### Планы развития

- [ ] Добавление новых технических индикаторов (Stochastic, ATR, ADX)
- [ ] Поддержка комиссий брокера в бэктесте
- [ ] Оптимизация параметров правил (grid search)
- [ ] Экспорт результатов бэктеста в CSV/Excel
- [ ] Real-time уведомления при обнаружении консенсуса
- [ ] Добавление машинного обучения для предсказания успешности консенсуса

---

## Контакты и Поддержка

При возникновении вопросов или проблем:
1. Проверьте логи бэкенда: `tail -f logs/app.log`
2. Проверьте консоль браузера на предмет ошибок
3. Убедитесь, что все зависимости установлены
4. Проверьте соединение с базой данных

---

**Версия документа:** 1.0
**Дата обновления:** 2025-11-14
